// ===========================
// login.js (versão corrigida)
// ===========================

// 1. Elementos do DOM
const loginForm = document.getElementById('login-form');
const cpfInput = document.getElementById('cpf');
const senhaInput = document.getElementById('senha');
const loginButton = document.getElementById('login-button');
const errorMessage = document.getElementById('error-message');

// ===============================
// 2. Carregar usuários do ENV.js
// ===============================
let USUARIOS_TESTE = {};

try {
    if (typeof ENV !== 'undefined' && ENV.USUARIOS_TESTE) {
        USUARIOS_TESTE = ENV.USUARIOS_TESTE;
    } else {
        console.warn("⚠️ ENV.USUARIOS_TESTE não encontrado.");
    }
} catch (err) {
    console.error("Erro ao carregar ENV:", err);
}

// ===============================
// 3. Verificação de sessão ativa
// ===============================
if (sessionStorage.getItem('usuarioLogado') === 'true') {
    window.location.href = 'index.html';
}

// ===============================
// 4. Função para limpar CPF
// ===============================
function limparCPF(cpf) {
    return cpf.replace(/\D/g, ''); // remove pontos, traços e tudo que não for número
}

// ===============================
// 5. Listener do formulário
// ===============================
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();

    let cpf = limparCPF(cpfInput.value.trim());
    let senha = senhaInput.value.trim();

    loginButton.disabled = true;
    loginButton.textContent = 'Entrando...';
    errorMessage.textContent = '';

    // DEBUG opcional
    // console.log("CPF digitado:", cpf);
    // console.log("Usuários carregados:", USUARIOS_TESTE);

    // ===============================
    // 6. Verificação de usuário
    // ===============================
    if (USUARIOS_TESTE[cpf] && USUARIOS_TESTE[cpf].senha === senha) {

        sessionStorage.setItem('usuarioLogado', 'true');
        sessionStorage.setItem('usuarioNome', USUARIOS_TESTE[cpf].nome);

        window.location.href = 'index.html';
    
    } else {
        errorMessage.textContent = 'CPF ou senha inválidos.';
        loginButton.disabled = false;
        loginButton.textContent = 'Entrar';
    }
});
